<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stop Before The Word — Test local (sans build)</title>
    <!-- Tailwind CDN (pour style rapide) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React UMD + ReactDOM UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel Standalone pour compiler JSX dans le navigateur -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect, useMemo, useRef } = React;

      // =============== Porte: Mot de passe (clair) ===============
      const PASSWORD = "secret"; // ← change-moi ici

      function PasswordGate({ children }) {
        const [ok, setOk] = useState(false);
        const [pwd, setPwd] = useState("");

        useEffect(() => {
          try {
            const token = localStorage.getItem("sbw.auth");
            if (token === PASSWORD) setOk(true);
          } catch {}
        }, []);

        const onSubmit = (e) => {
          e.preventDefault();
          if (pwd === PASSWORD) {
            try { localStorage.setItem("sbw.auth", PASSWORD); } catch {}
            setOk(true);
            setPwd("");
          } else {
            alert("Mot de passe incorrect");
          }
        };

        if (ok) return children;

        return (
          <div className="min-h-screen grid place-items-center bg-slate-900 text-slate-200 p-6">
            <form onSubmit={onSubmit} className="bg-slate-800 p-5 rounded-2xl w-full max-w-xs shadow-xl">
              <h1 className="text-xl font-bold mb-2">Accès privé</h1>
              <p className="text-sm opacity-80 mb-3">Entre le mot de passe pour jouer.</p>
              <input
                type="password"
                placeholder="Mot de passe"
                value={pwd}
                onChange={(e) => setPwd(e.target.value)}
                className="w-full border border-slate-600 bg-slate-900 text-slate-100 rounded-xl p-2 mb-2"
              />
              <button type="submit" className="w-full p-2 rounded-xl bg-emerald-500 text-emerald-950 font-semibold">
                Entrer
              </button>
              <p className="text-xs opacity-60 mt-2">Astuce : modifie la constante <code>PASSWORD</code> dans ce fichier.</p>
            </form>
          </div>
        );
      }

      // =============== Jeu ===============
      const DEFAULT_VIDEOS = [
        {
          id: "demo-flower",
          title: "Démo – Flower (CC0)",
          src: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4",
          keyword: "le mot secret",
          limitTime: 4.2,
          displayFuzz: 0.5, // ± secondes affichées aux joueurs
          hideTimer: true,  // masque l'horloge côté joueurs
        },
      ];

      // Storage utils
      function loadVideos() {
        try { const raw = localStorage.getItem("sbw.videos"); if (raw) return JSON.parse(raw); } catch {}
        return DEFAULT_VIDEOS;
      }
      function saveVideos(videos) { try { localStorage.setItem("sbw.videos", JSON.stringify(videos)); } catch {} }
      function loadName() { try { return localStorage.getItem("sbw.playerName") || ""; } catch { return ""; } }
      function saveName(name) { try { localStorage.setItem("sbw.playerName", name); } catch {} }
      function loadLeaderboard(videoId) { try { const raw = localStorage.getItem(`sbw.lb.${videoId}`); if (raw) return JSON.parse(raw); } catch {} return []; }
      function saveLeaderboard(videoId, list) { try { localStorage.setItem(`sbw.lb.${videoId}`, JSON.stringify(list)); } catch {} }

      // Format utils
      function uid(prefix="id"){ return `${prefix}_${Math.random().toString(36).slice(2,9)}`; }
      function formatTime(s){
        if (!isFinite(s)) return "0:00.000";
        const sign = s < 0 ? "-" : "";
        const x = Math.abs(s);
        const m = Math.floor(x/60);
        const sec = Math.floor(x % 60).toString().padStart(2,"0");
        const ms  = Math.round((x*1000)%1000).toString().padStart(3,"0");
        return `${sign}${m}:${sec}.${ms}`;
      }
      function formatTimeCoarse(s){
        if (!isFinite(s)) return "0:00";
        const sign = s < 0 ? "-" : "";
        const x = Math.abs(s);
        const m = Math.floor(x/60);
        const sec = Math.floor(x % 60).toString().padStart(2,"0");
        return `${sign}${m}:${sec}`;
      }
      function computeScore(pausedAt, limitTime){
        const diff = limitTime - pausedAt; // ≥0 = avant
        if (diff < 0) return { score: 0, diff };
        const points = Math.max(1, Math.round(100 - (diff / 0.05))); // −1 point / 50ms
        return { score: points, diff };
      }

      function GameApp(){
        const videoRef = useRef(null);

        const [videos, setVideos] = useState(() => loadVideos());
        const [currentId, setCurrentId] = useState(() => (videos[0] ? videos[0].id : ""));
        const current = useMemo(() => videos.find(v => v.id === currentId) || null, [videos, currentId]);

        const [playerName, setPlayerName] = useState(() => loadName());
        const [curTime, setCurTime] = useState(0);
        const [result, setResult] = useState(null);
        const [error, setError] = useState(null);

        const admin = (typeof window !== "undefined") && (new URLSearchParams(window.location.search).get("admin") === "1");

        useEffect(() => { saveVideos(videos); }, [videos]);
        useEffect(() => {
          const v = videoRef.current;
          if (!v) return;
          const onTime = () => setCurTime(v.currentTime || 0);
          v.addEventListener("timeupdate", onTime);
          return () => v.removeEventListener("timeupdate", onTime);
        }, [currentId]);

        const start = async () => {
          setResult(null); setError(null);
          const v = videoRef.current; if (!v || !current) return;
          try { v.currentTime = 0; await v.play(); } catch { setError("Lecture bloquée, cliquez encore sur Démarrer."); }
        };
        const stopBefore = () => {
          const v = videoRef.current; if (!v || !current) return;
          v.pause();
          const pausedAt = v.currentTime;
          const { score, diff } = computeScore(pausedAt, current.limitTime);
          const attempt = { name: playerName || "Anonyme", pausedAt, score, diff, ts: Date.now() };
          setResult(attempt);
          const lb = loadLeaderboard(current.id);
          lb.push(attempt);
          lb.sort((a,b) => (b.score - a.score) || (Math.abs(a.diff) - Math.abs(b.diff)));
          saveLeaderboard(current.id, lb.slice(0,20));
        };

        // Admin
        const setLimitHere = () => {
          const v = videoRef.current; if (!v || !current) return;
          const t = Number(v.currentTime.toFixed(3));
          setVideos(arr => arr.map(it => it.id === current.id ? { ...it, limitTime: t } : it));
        };
        const addVideo = () => {
          const id = uid("vid");
          const newItem = { id, title: "Nouvelle vidéo", src: "https://example.com/video.mp4", keyword: "mot", limitTime: 3, displayFuzz: 0.5, hideTimer: true };
          setVideos(v => [newItem, ...v]); setCurrentId(id);
        };
        const removeCurrent = () => {
          if (!current) return;
          const next = videos.filter(v => v.id !== current.id);
          setVideos(next);
          if (next[0]) setCurrentId(next[0].id);
        };
        const exportJSON = () => {
          const json = JSON.stringify(videos, null, 2);
          navigator.clipboard.writeText(json).catch(() => {});
          alert("Configuration copiée dans le presse-papiers.");
        };
        const importJSON = async () => {
          const txt = prompt("Collez ici le JSON des vidéos (tableau)"); if (!txt) return;
          try {
            const arr = JSON.parse(txt); if (!Array.isArray(arr)) throw new Error("Format invalide");
            setVideos(arr); if (arr[0]) setCurrentId(arr[0].id);
          } catch (e) { alert("JSON invalide: " + (e?.message || e)); }
        };
        const leaderboard = useMemo(() => (current ? loadLeaderboard(current.id) : []), [currentId]);

        return (
          <div className="min-h-screen bg-gray-50 text-gray-900 p-4 sm:p-6">
            <div className="max-w-5xl mx-auto grid gap-4">
              <header className="flex items-center justify-between">
                <h1 className="text-2xl sm:text-3xl font-bold">Stop Before The Word</h1>
                {admin ? <span className="text-xs px-2 py-1 rounded bg-purple-100 text-purple-700">Mode Admin</span> : null}
              </header>

              {/* Sélection & Profil */}
              <section className="grid gap-3 bg-white rounded-2xl shadow p-4">
                <div className="flex flex-col sm:flex-row gap-3">
                  <div className="flex-1">
                    <label className="text-sm font-medium">Choisir une vidéo</label>
                    <select className="w-full border rounded-xl p-2" value={currentId} onChange={(e) => setCurrentId(e.target.value)}>
                      {videos.map(v => <option key={v.id} value={v.id}>{v.title}</option>)}
                    </select>
                  </div>
                  <div className="w-full sm:w-64">
                    <label className="text-sm font-medium">Votre pseudo</label>
                    <input className="w-full border rounded-xl p-2" placeholder="Ex: Léo" value={playerName}
                           onChange={(e) => { setPlayerName(e.target.value); saveName(e.target.value); }} />
                  </div>
                </div>

                {current ? (
                  <p className="text-sm text-gray-600">
                    Objectif: stoppez <strong>avant</strong> la limite liée au mot <span className="font-semibold italic">“{current.keyword}”</span>.{" "}
                    {(current.displayFuzz || 0) > 0 && !admin ? (
                      <>
                        La limite se situe quelque part entre{" "}
                        <span className="font-semibold tabular-nums">{formatTimeCoarse(current.limitTime - (current.displayFuzz || 0))}</span>{" "}
                        et{" "}
                        <span className="font-semibold tabular-nums">{formatTimeCoarse(current.limitTime + (current.displayFuzz || 0))}</span>.
                      </>
                    ) : (
                      admin ? <>Limite exacte (admin): <span className="font-semibold tabular-nums">{formatTime(current.limitTime)}</span></> : null
                    )}
                  </p>
                ) : null}
              </section>

              {/* Lecteur & Contrôles */}
              <section className="bg-white rounded-2xl shadow overflow-hidden">
                <div className="aspect-video bg-black">
                  <video ref={videoRef} src={current ? current.src : ""} className="w-full h-full" preload="metadata" />
                </div>
                <div className="p-4 grid gap-3">
                  <div className="flex items-center justify-between text-sm text-gray-600">
                    {admin ? (
                      <span>Temps: <span className="tabular-nums font-medium">{formatTime(curTime)}</span></span>
                    ) : (
                      current && !current.hideTimer ? (
                        <span>Temps: <span className="tabular-nums font-medium">{formatTimeCoarse(curTime)}</span></span>
                      ) : <span></span>
                    )}
                    {current && admin ? (
                      <span>Limite (exacte): <span className="tabular-nums font-semibold">{formatTime(current.limitTime)}</span></span>
                    ) : <span></span>}
                  </div>
                  <div className="flex gap-3 flex-wrap">
                    <button onClick={start} className="px-4 py-2 rounded-2xl bg-emerald-600 text-white font-semibold shadow hover:bg-emerald-700">Démarrer</button>
                    <button onClick={stopBefore} className="px-4 py-2 rounded-2xl bg-rose-600 text-white font-semibold shadow hover:bg-rose-700">STOP (avant la limite)</button>
                    {admin ? <button onClick={() => videoRef.current && videoRef.current.play()} className="px-3 py-2 rounded-2xl bg-gray-200 text-gray-800 font-medium">Lecture</button> : null}
                    {admin ? <button onClick={() => videoRef.current && videoRef.current.pause()} className="px-3 py-2 rounded-2xl bg-gray-200 text-gray-800 font-medium">Pause</button> : null}
                  </div>

                  {result ? (
                    <div className="rounded-xl border bg-gray-50 p-3">
                      <p className="text-sm">Vous avez stoppé à <strong className="tabular-nums">{formatTime(result.pausedAt)}</strong>.</p>
                      <p className="text-sm">Écart vs limite: <strong className="tabular-nums">{formatTime(result.diff)}</strong> ({result.diff < 0 ? "après : 0 point" : "avant : points"}).</p>
                      <p className="text-lg font-bold mt-1">Score: {result.score}</p>
                    </div>
                  ) : null}

                  {error ? <p className="text-sm text-rose-600">{error}</p> : null}
                </div>
              </section>

              {/* Classement local */}
              <section className="bg-white rounded-2xl shadow p-4">
                <h2 className="text-lg font-semibold mb-3">Classement (local, {current ? current.title : ""})</h2>
                {leaderboard.length === 0 ? (
                  <p className="text-sm text-gray-600">Aucune tentative pour l'instant.</p>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="min-w-full text-sm">
                      <thead>
                        <tr className="text-left text-gray-500">
                          <th className="py-2 pr-4">#</th>
                          <th className="py-2 pr-4">Pseudo</th>
                          <th className="py-2 pr-4">Stop</th>
                          <th className="py-2 pr-4">Écart</th>
                          <th className="py-2 pr-4">Score</th>
                          <th className="py-2 pr-4">Date</th>
                        </tr>
                      </thead>
                      <tbody>
                        {leaderboard.map((a, i) => (
                          <tr key={a.ts} className="border-t">
                            <td className="py-2 pr-4">{i + 1}</td>
                            <td className="py-2 pr-4">{a.name}</td>
                            <td className="py-2 pr-4 tabular-nums">{formatTime(a.pausedAt)}</td>
                            <td className={"py-2 pr-4 tabular-nums " + (a.diff < 0 ? "text-rose-600" : "text-emerald-700")}>{formatTime(a.diff)}</td>
                            <td className="py-2 pr-4 font-semibold">{a.score}</td>
                            <td className="py-2 pr-4">{new Date(a.ts).toLocaleString()}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </section>

              {/* Admin */}
              {admin && current ? (
                <section className="bg-white rounded-2xl shadow p-4 grid gap-3">
                  <h2 className="text-lg font-semibold">Administration</h2>

                  <div className="grid sm:grid-cols-2 gap-3">
                    <div>
                      <label className="text-sm font-medium">Titre</label>
                      <input className="w-full border rounded-xl p-2" value={current.title}
                             onChange={(e) => setVideos(v => v.map(it => it.id === current.id ? { ...it, title: e.target.value } : it))} />
                    </div>
                    <div>
                      <label className="text-sm font-medium">Mot clé</label>
                      <input className="w-full border rounded-xl p-2" value={current.keyword}
                             onChange={(e) => setVideos(v => v.map(it => it.id === current.id ? { ...it, keyword: e.target.value } : it))} />
                    </div>
                  </div>

                  <div>
                    <label className="text-sm font-medium">URL vidéo (.mp4)</label>
                    <input className="w-full border rounded-xl p-2" value={current.src}
                           onChange={(e) => setVideos(v => v.map(it => it.id === current.id ? { ...it, src: e.target.value } : it))} />
                    <p className="text-xs text-gray-500 mt-1">Astuce: place tes .mp4 dans le repo (ex: /assets/ma_video.mp4) ou utilise une URL publique.</p>
                  </div>

                  <div className="grid sm:grid-cols-3 gap-3 items-end">
                    <div>
                      <label className="text-sm font-medium">Limite (secondes)</label>
                      <input type="number" step="0.001" className="w-full border rounded-xl p-2" value={current.limitTime}
                             onChange={(e) => setVideos(v => v.map(it => it.id === current.id ? { ...it, limitTime: Number(e.target.value) } : it))} />
                      <p className="text-xs text-gray-500 mt-1">Les joueurs voient une <strong>plage</strong> si une marge est définie.</p>
                    </div>
                    <button onClick={setLimitHere} className="px-4 py-2 rounded-2xl bg-indigo-600 text-white font-semibold shadow hover:bg-indigo-700">Fixer la limite = temps courant</button>
                    <div className="text-sm text-gray-600">Temps courant: <span className="tabular-nums font-medium">{formatTime(curTime)}</span></div>
                  </div>

                  <div className="grid sm:grid-cols-3 gap-3 items-end">
                    <div>
                      <label className="text-sm font-medium">Marge affichée (± secondes)</label>
                      <input type="number" step="0.05" className="w-full border rounded-xl p-2" value={current.displayFuzz || 0}
                             onChange={(e) => setVideos(v => v.map(it => it.id === current.id ? { ...it, displayFuzz: Number(e.target.value) } : it))} />
                      <p className="text-xs text-gray-500 mt-1">Ex: 0.5 ⇒ plage [limite-0.5 ; limite+0.5]. Mettre 0 pour rien afficher.</p>
                    </div>
                    <div className="flex items-center gap-2">
                      <input id="hideTimer" type="checkbox" className="h-4 w-4" checked={!!current.hideTimer}
                             onChange={(e) => setVideos(v => v.map(it => it.id === current.id ? { ...it, hideTimer: e.target.checked } : it))} />
                      <label htmlFor="hideTimer" className="text-sm">Masquer l'horloge aux joueurs</label>
                    </div>
                  </div>

                  <div className="flex flex-wrap gap-3">
                    <button onClick={addVideo} className="px-4 py-2 rounded-2xl bg-gray-800 text-white font-semibold shadow">+ Ajouter une vidéo</button>
                    <button onClick={removeCurrent} className="px-4 py-2 rounded-2xl bg-gray-200 text-gray-800 font-semibold shadow">Supprimer la vidéo</button>
                    <button onClick={exportJSON} className="px-4 py-2 rounded-2xl bg-emerald-600 text-white font-semibold shadow">Exporter JSON</button>
                    <button onClick={importJSON} className="px-4 py-2 rounded-2xl bg-amber-600 text-white font-semibold shadow">Importer JSON</button>
                  </div>
                </section>
              ) : null}

              <footer className="text-center text-xs text-gray-500 py-6">
                Test local sans build • Pour le mode admin, ajoute <code>?admin=1</code> à l'URL.
              </footer>
            </div>
          </div>
        );
      }

      function App(){
        return (
          <PasswordGate>
            <GameApp />
          </PasswordGate>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
